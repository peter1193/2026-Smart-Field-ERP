/**
 * [ëª¨ë“ˆ 12] 12_UIHandler.gs
 * í”„ë¡œì íŠ¸: 2026 Smart Field ERP (AI ë¹„ì„œ í†µí•©í˜•)
 * ì—­í• : ìµœì¢… ë¦¬ëª¨ë¸ë§ëœ 10ê°œ ëŒ€ë¶„ë¥˜ ë¦¬ëª¨ì»¨ UI ë° í˜„í™©íŒ ì œì–´
 * ìµœì¢… ì—…ë°ì´íŠ¸: 2026-02-23 (í•­ëª©ëª… ë§¤ì¹­ ë°©ì‹ ë„ì…ìœ¼ë¡œ ë°ì´í„° ë°€ë¦¼ í˜„ìƒ ì™„ì „ í•´ê²°)
 */

/** ğŸ› ï¸ [ìˆ˜ë™ ì‹¤í–‰] ë§ˆìŠ¤í„° ëŒ€ì‹œë³´ë“œ ë° ìµœì¢… ë¦¬ëª¨ë¸ë§ ë²„íŠ¼ ê°•ì œ ë¡œë“œ */
function ë§ˆìŠ¤í„°_ë¦¬ëª¨ì»¨_ê°•ì œë¡œë“œ() {
  const ë§ˆìŠ¤í„°ID = CONFIG.ADMIN_ID;
  const ê¶Œí•œ = { isMaster: true, isAdmin: true, name: "ê°•ì„±ë¬µ ê³¼ì¥" }; 
  return UIHandler.ë§ˆìŠ¤í„°_ëŒ€ì‹œë³´ë“œ_ë°œì†¡(ë§ˆìŠ¤í„°ID, ê¶Œí•œ);
}

const UIHandler = {

  /**
   * ğŸ“± 1. ë©”ì¸ ë¦¬ëª¨ì»¨ êµ¬ì„± (ìµœì¢… 10ê°œ ë²„íŠ¼ ì²´ê³„)
   * ê³¼ì¥ë‹˜ ìš´ì˜ ì§€ì¹¨: ì¼ì •ê´€ë¦¬ ëª…ì¹­ ë³µêµ¬, ì§ì›ì†Œí†µ ë³€ê²½, ê¸´ê¸‰ì‹¸ì´ë Œ ì¤‘ì•™ ë°°ì¹˜
   */
  ë©”ì¸_ë¦¬ëª¨ì»¨_êµ¬ì„±: function() {
    return {
      keyboard: [
        [{ text: "ğŸ“Š ì¶œì„ì²´í¬" }, { text: "ğŸ’° ìˆ˜ë‹¹/ì •ì‚°" }, { text: "ğŸ“… ì¼ì •ê´€ë¦¬" }],
        [{ text: "ğŸšœ í˜„ì¥ê´€ì œ" }, { text: "ğŸš¨ ê¸´ê¸‰ì‹¸ì´ë Œ" }, { text: "ğŸ“¦ ìì¬ê³ " }], 
        [{ text: "ğŸ“¢ ì „ì²´ê³µì§€" }, { text: "ğŸ’¬ ì§ì›ì†Œí†µ" }, { text: "ğŸ“ ì‘ì—…ì¼ì§€" }],
        [{ text: "ğŸ  ë©”ì¸ë©”ë‰´" }, { text: "âš™ï¸ ëª¨ë“œì „í™˜" }]
      ],
      resize_keyboard: true,
      one_time_keyboard: false,
      input_field_placeholder: "ğŸ¤ ë³´ê³ í•  ë‚´ìš©ì´ë‚˜ ì§€ì‹œì‚¬í•­ì„ ë§ì”€í•˜ì„¸ìš”"
    };
  },

  /**
   * ğŸ’» 2. ë§ˆìŠ¤í„° í†µí•© ê´€ì œ ëŒ€ì‹œë³´ë“œ ë°œì†¡
   */
  ë§ˆìŠ¤í„°_ëŒ€ì‹œë³´ë“œ_ë°œì†¡: function(ì±„íŒ…ID, ê¶Œí•œ) {
    const ë°ì´í„° = this.ëŒ€ì‹œë³´ë“œ_ë°ì´í„°_ìˆ˜ì§‘();

    const ë©”ì‹œì§€ =
      "ğŸ—ï¸ <b>[2026 SMART FIELD ERP ê´€ì œ]</b>\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "ğŸ‘¤ <b>ê´€ë¦¬ì:</b> " + ê¶Œí•œ.name + " ê³¼ì¥ë‹˜\n" +
      "ğŸ‡ <b>ì¬ê³ :</b> " + ë°ì´í„°.ì°½ê³ í˜„í™© + "\n" +
      "ğŸ“… <b>ì˜¤ëŠ˜ ì¼ì •:</b> " + ë°ì´í„°.ì¼ì •ìš”ì•½ + "\n" +
      "ğŸ’° <b>ë¯¸ê²°:</b> " + ë°ì´í„°.ì •ì‚°ìš”ì•½ + "\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "ğŸ“¡ <b>ì‹œìŠ¤í…œ ìƒíƒœ:</b> ì‹¤ì‹œê°„ ê°ì‹œ ì¤‘";

    const ì¸ë¼ì¸_ë²„íŠ¼ = {
      inline_keyboard: [
        [{ text: "ğŸ“Š ì‹¤ì‹œê°„ í†µê³„ ë¶„ì„", callback_data: "í†µê³„_ì¡°íšŒ" }],
        [{ text: "ğŸ“‚ ERP ì‹œíŠ¸ ë°”ë¡œê°€ê¸°", url: "https://docs.google.com/spreadsheets/d/" + CONFIG.SS_ID }]
      ]
    };

    // ëŒ€ì‹œë³´ë“œ ë©”ì‹œì§€ ë°œì†¡
    Telegram.call('sendMessage', {
      chat_id: ì±„íŒ…ID,
      text: ë©”ì‹œì§€,
      parse_mode: "HTML",
      reply_markup: ì¸ë¼ì¸_ë²„íŠ¼
    });

    // í•˜ë‹¨ ë¦¬ëª¨ì»¨ í™œì„±í™”
    return Telegram.call('sendMessage', {
      chat_id: ì±„íŒ…ID,
      text: "âŒ¨ï¸ <b>í˜„ì¥ ë¦¬ëª¨ë¸ë§ ë¦¬ëª¨ì»¨ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</b>",
      parse_mode: "HTML",
      reply_markup: this.ë©”ì¸_ë¦¬ëª¨ì»¨_êµ¬ì„±()
    });
  },

  /**
   * ğŸ“Š 3. [ì¶œì„ì²´í¬] í˜„í™©íŒ ë° ë©”ë‰´
   */
  ì¶œì„_ë©”ë‰´_í‘œì‹œ: function(chatId) {
    const ë°ì´í„° = this.ëŒ€ì‹œë³´ë“œ_ë°ì´í„°_ìˆ˜ì§‘();
    const ë©”ì‹œì§€ = 
      "ğŸ“Š <b>[ì‹¤ì‹œê°„ ì¶œì„ í˜„í™©]</b>\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "ğŸ‘¥ <b>í˜„ì¬ ì¶œê·¼:</b> " + ë°ì´í„°.ì¶œì„ìš”ì•½ + "\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "ì¶œì„ ì—…ë¬´ë¥¼ ì„ íƒí•˜ì‹­ì‹œì˜¤.";

    const inline = {
      inline_keyboard: [
        [{ text: "ğŸ“ ì¶œê·¼ë“±ë¡", callback_data: "attendance_in" }, { text: "ğŸ  í‡´ê·¼ë§ˆê°", callback_data: "attendance_out" }],
        [{ text: "ğŸ“‹ ìƒì„¸ëª…ë¶€", callback_data: "attendance_status" }]
      ]
    };

    return Telegram.call('sendMessage', {
      chat_id: chatId,
      text: ë©”ì‹œì§€,
      parse_mode: "HTML",
      reply_markup: inline
    });
  },

  /**
   * ğŸ’° 4. [ìˆ˜ë‹¹/ì •ì‚°] í˜„í™©íŒ ë° ë©”ë‰´
   */
  ì •ì‚°_ë©”ë‰´_í‘œì‹œ: function(chatId) {
    const ë°ì´í„° = this.ëŒ€ì‹œë³´ë“œ_ë°ì´í„°_ìˆ˜ì§‘();
    const ë©”ì‹œì§€ =
      "ğŸ’° <b>[ìˆ˜ë‹¹ ë° ì •ì‚° ê´€ë¦¬]</b>\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "ğŸ’µ <b>ë¯¸ê²°ì œ ì´ì•¡:</b> " + ë°ì´í„°.ì •ì‚°ìš”ì•½ + "\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "ì •ì‚° ë‚´ì—­ì„ ìŠ¹ì¸í•˜ì‹­ì‹œì˜¤.";

    const ì¸ë¼ì¸ = {
      inline_keyboard: [
        [{ text: "ğŸ’¸ ë¯¸ê²°ìŠ¹ì¸", callback_data: "pay_pending" }, { text: "ğŸ“Š ì›”ê°„ë³´ê³ ", callback_data: "pay_monthly" }]
      ]
    };

    return Telegram.call('sendMessage', {
      chat_id: chatId,
      text: ë©”ì‹œì§€,
      parse_mode: "HTML",
      reply_markup: ì¸ë¼ì¸
    });
  },

  /**
   * ğŸ’¬ 5. [ì§ì›ì†Œí†µ] ë©”ë‰´
   */
  ì†Œí†µ_ë©”ë‰´_í‘œì‹œ: function(chatId) {
    const ë©”ì‹œì§€ = 
      "ğŸ’¬ <b>[ì§ì›ì†Œí†µ ì„¼í„°]</b>\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "ë‹¤êµ­ì–´ ìë™ ë²ˆì—­ì„ í†µí•œ ì–‘ë°©í–¥ ì†Œí†µ ì±„ë„ì…ë‹ˆë‹¤.\n" +
      "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n" +
      "ëª…ë ¹ì„ ë‚´ë¦¬ê±°ë‚˜ ê¸°ë¡ì„ í™•ì¸í•˜ì„¸ìš”.";

    const inline = {
      inline_keyboard: [
        [{ text: "ğŸ“¢ ê³µì§€ë°œì†¡", callback_data: "msg_broadcast" }, { text: "ğŸ‘¥ êµ­ê°€ë³„ì„ íƒ", callback_data: "msg_nation_limit" }],
        [{ text: "ğŸ“– ì†Œí†µê¸°ë¡", callback_data: "msg_history" }]
      ]
    };
    return Telegram.call('sendMessage', {
      chat_id: chatId,
      text: ë©”ì‹œì§€,
      parse_mode: "HTML",
      reply_markup: inline
    });
  },

  /**
   * ğŸ‘· 6. ê·¼ë¡œì ì „ìš© ë©”ë‰´
   */
  ê·¼ë¡œì_ë©”ë‰´_ë°œì†¡: function(ì±„íŒ…ID, ê¶Œí•œ) {
    const ì–¸ì–´ = ê¶Œí•œ.lang || "KO";
    const ë¼ë²¨ = {
      "KO": { ì…: "ğŸ“ ì¶œê·¼ ì¸ì¦", ì¶œ: "ğŸ  ì—…ë¬´ ì¢…ë£Œ", ê¸¸: "ğŸš— í˜„ì¥ ê¸¸ì°¾ê¸°" },
      "VI": { ì…: "ğŸ“ Äiá»ƒm danh", ì¶œ: "ğŸ  Káº¿t thÃºc", ê¸¸: "ğŸš— Chá»‰ Ä‘Æ°á»ng" },
      "TH": { ì…: "ğŸ“ à¸¥à¸‡à¸Šà¸·à¹ˆà¸­à¹€à¸‚à¹‰à¸²", ì¶œ: "ğŸ  à¹€à¸¥à¸´à¸à¸‡à¸²à¸™", ê¸¸: "ğŸš— à¸™à¸³à¸—à¸²à¸‡" },
      "KH": { ì…: "ğŸ“ à¸ˆìš°áˆáŸ’á˜áŸ„áŸ‡á…á¼á›", ì¶œ: "ğŸ  à¸šà¸±à¸à¸ˆà¸š", ê¸¸: "ğŸš— á“á¶áŸ†á•áŸ’á›á¼áœ" },
      "PH": { ì…: "ğŸ“ Mag-check in", ì¶œ: "ğŸ  Tapusin", ê¸¸: "ğŸš— Mag-navigate" }
    };

    const p = ë¼ë²¨[ì–¸ì–´] || ë¼ë²¨["KO"];

    const ì¸ë¼ì¸_ë²„íŠ¼ = {
      inline_keyboard: [
        [{ text: p.ì…, callback_data: "job_in" }, { text: p.ì¶œ, callback_data: "job_out" }],
        [{ text: p.ê¸¸, callback_data: "find_my_site" }]
      ]
    };

    Telegram.call('sendMessage', {
      chat_id: ì±„íŒ…ID,
      text: "ğŸ‘· <b>ë‚˜ì£¼ ìŠ¤ë§ˆíŠ¸ í˜„ì¥ ë©”ë‰´</b>",
      parse_mode: "HTML",
      reply_markup: ì¸ë¼ì¸_ë²„íŠ¼
    });

    return Telegram.call('sendMessage', {
      chat_id: ì±„íŒ…ID,
      text: "âœ… ì›í•˜ì‹œëŠ” ì‘ì—…ì„ ì„ íƒí•˜ì„¸ìš”.",
      parse_mode: "HTML",
      reply_markup: {
        keyboard: [[{ text: "ğŸ  ë©”ì¸ë©”ë‰´" }]],
        resize_keyboard: true
      }
    });
  },

  /**
   * ğŸ“Š 7. ëŒ€ì‹œë³´ë“œ ë°ì´í„° ìˆ˜ì§‘ (ì§€ëŠ¥í˜• í•­ëª© ë§¤ì¹­ ë„ì…)
   * ì¤„ ë²ˆí˜¸ì— ì˜ì¡´í•˜ì§€ ì•Šê³  Aì—´ì˜ í…ìŠ¤íŠ¸ë¥¼ ì°¾ì•„ Bì—´ì˜ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
   */
  ëŒ€ì‹œë³´ë“œ_ë°ì´í„°_ìˆ˜ì§‘: function() {
    const ìºì‹œ = CacheService.getScriptCache();
    // ê°•ì œ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ìºì‹œ í™•ì¸ ê³¼ì •ì„ ìƒëµí•˜ê±°ë‚˜ ì§§ê²Œ ê°€ì ¸ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    
    const ê²°ê³¼ = { 
      ì°½ê³ í˜„í™©: "ë°ì´í„° ì—†ìŒ",
      ì¼ì •ìš”ì•½: "ì¼ì •ì—†ìŒ", 
      ì´ìƒì§•í›„: "ì •ìƒ",
      ì¶œì„ìš”ì•½: "0ëª…",
      ì‘ì—…í˜„í™©: "ê¸°ë¡ ì—†ìŒ",
      ì •ì‚°ìš”ì•½: "0ì›",
      í˜„ì¥ìš”ì•½: "ì—†ìŒ",
      ê°±ì‹ ì‹œê°„: Utilities.formatDate(new Date(), "GMT+9", "HH:mm:ss")
    };

    try {
      const ss = SpreadsheetApp.openById(CONFIG.SS_ID);
      const ë´‡ì‹œíŠ¸ = ss.getSheetByName(CONFIG.SHEETS.BOT_DB);

      if (ë´‡ì‹œíŠ¸) {
        // A1ë¶€í„° B15ê¹Œì§€ ë°ì´í„°ë¥¼ í†µì§¸ë¡œ ì½ì–´ì˜µë‹ˆë‹¤.
        const ë°ì´í„°ë²”ìœ„ = ë´‡ì‹œíŠ¸.getRange("A1:B15").getValues();
        
        // ì¤„ ë²ˆí˜¸ê°€ ì•„ë‹ˆë¼ 'í•­ëª©ëª…'ì„ ëŒ€ì¡°í•´ì„œ ê°’ì„ ì°¾ìŠµë‹ˆë‹¤.
        ë°ì´í„°ë²”ìœ„.forEach(row => {
          const í•­ëª©ëª… = String(row[0]).trim();
          const ê°’ = String(row[1]).trim();
          
          const isValid = (v) => v && v !== "null" && v !== "undefined" && v.indexOf("#") === -1;

          // 'ì¼ì •ê´€ë¦¬'ë¼ëŠ” ê¸€ìê°€ í¬í•¨ëœ í–‰ì„ ì°¾ì•„ ê°’ì„ ë§¤í•‘
          if (í•­ëª©ëª….includes("ì¼ì •ê´€ë¦¬")) {
            ê²°ê³¼.ì¼ì •ìš”ì•½ = isValid(ê°’) ? ê°’ : "ì¼ì •ì—†ìŒ";
          }
          // 'ì°½ê³ ê´€ë¦¬' ë˜ëŠ” 'ì¬ê³ 'ë¼ëŠ” ê¸€ìê°€ í¬í•¨ëœ í–‰ ë§¤í•‘
          if (í•­ëª©ëª….includes("ì°½ê³ ê´€ë¦¬") || í•­ëª©ëª….includes("ì¬ê³ ")) {
            ê²°ê³¼.ì°½ê³ í˜„í™© = isValid(ê°’) ? ê°’ : "ë°ì´í„° ì—†ìŒ";
          }
          // ê¸°íƒ€ í•­ëª©ë“¤ ë§¤í•‘
          if (í•­ëª©ëª….includes("ì¶œì„")) ê²°ê³¼.ì¶œì„ìš”ì•½ = isValid(ê°’) ? ê°’ : "0ëª…";
          if (í•­ëª©ëª….includes("ì •ì‚°") || í•­ëª©ëª….includes("ë¯¸ê²°")) ê²°ê³¼.ì •ì‚°ìš”ì•½ = isValid(ê°’) ? ê°’ : "0ì›";
          if (í•­ëª©ëª….includes("ì´ìƒ")) ê²°ê³¼.ì´ìƒì§•í›„ = isValid(ê°’) ? ê°’ : "ì •ìƒ";
          if (í•­ëª©ëª….includes("í˜„ì¥")) ê²°ê³¼.í˜„ì¥ìš”ì•½ = isValid(ê°’) ? ê°’ : "ì—†ìŒ";
        });

        ìºì‹œ.put("ê´€ì œ_ëŒ€ì‹œë³´ë“œ_ë°ì´í„°", JSON.stringify(ê²°ê³¼), 30);
      }
    } catch (e) {
      console.error("ë°ì´í„° ìˆ˜ì§‘ ì˜¤ë¥˜: " + e.toString());
    }
    return ê²°ê³¼;
  }
};